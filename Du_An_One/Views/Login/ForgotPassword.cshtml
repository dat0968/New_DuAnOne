@model ForgotPassword
@{
    ViewData["Title"] = "Forgot Password";
    Layout = null;
}

<head>@* 
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" /> *@
    <link rel="stylesheet" href="~/css/style_LRF.css" asp-append-version="true" />@* 
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="https://unpkg.com/unlazy@0.11.3/dist/unlazy.with-hashing.iife.js"
            defer
            init></script> *@
</head>
@* <div class="row">
    <div class="col-md-4">
        <form asp-controller="Login" asp-action="GuiMail">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group">
                <label asp-for="Email" class="control-label"></label>
                <input asp-for="Email" class="form-control" />
                <span asp-validation-for="Email" class="text-danger"></span>
            </div>
            <div class="form-group">
                <input type="submit" value="Send" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>
 *@

<div class="form-wrapper overlayQuenMK" id="overlayQuenMK>
    <div class="popupQuenMK">
    <h2>QUÊN MẬT KHẨU</h2>
    <p>Nhập Email của bạn để kiểm tra và lấy lại mật khẩu.</p>
    <form id="emailForm" method="post">
        <div class="form-control">
            <input type="email" name="Email" class="form-control" id="emailQuenMk" required />
            <label for="emailQuenMk">Email</label>
        </div>
        <button type="button" class="btn btn-primary" id="btnGuiMail">Gửi mã</button>
    </form>
    <!-- Add this section for confirmation code -->
    <form id="confirmationSection" style="display:none">
        <div class="form-control">
            <input type="number" name="ConfirmationCode" class="form-control" id="confirmationCode" required />
            <label for="confirmationCode">Mã xác nhận</label>
        </div>
        <button type="button" class="btn btn-primary" id="btnXacNhan">Xác nhận</button>
    </form>
    <form id="PasswordSection" style="display:none">
        <div class="form-control">
            <input type="password" name="Password" class="form-control" id="passwordMoi" required />
            <label for="passwordMoi">Mật khẩu mới</label>
        </div>
        <div class="form-control">
            <input type="password" name="ConfirmPassword" class="form-control" id="confirmPasswordMoi" required />
            <label for="confirmPasswordMoi">Nhập lại mật khẩu</label>
        </div>
        <button type="button" class="btn btn-primary" id="btn_LuuMatKhau">Xác nhận</button>
    </form>
    <form id="ChangeSuccess" style="text-align:center; color:white; font-weight:500; display:none">
        Mật khẩu đã được thay đổi, bạn có thể <a asp-action="Index">đăng nhập</a> lại.
    </form>
    </div>
    <p>
        Bạn đã có tài khoản?
        <a asp-action="Index">Đăng nhập ngay</a>
    </p>
    <small>
        Trang web này được bảo vệ bởi Google reCAPTCHA để đảm bảo bạn không phải là bot
        <a href="#">Tìm hiểu.</a>
    </small>
</div>



<script>
    function showPopupQuenMK() {
        document.getElementById("overlayQuenMK").style.display = "flex";
    }

    function hidePopup() {
        document.getElementById("overlayQuenMK").style.display = "none";
    }
</script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    $(document).ready(function () {
        var confirmationCode;

        $("#btnGuiMail").on("click", function () {
            var email = $("#emailQuenMk").val();

            $.ajax({
                type: "POST",
                url: "/Login/GuiMail",
                data: { Email: email },
                success: function (response) {
                    if (response.success) {
                        confirmationCode = response.confirmationCode;

                        $("#confirmationSection").show();
                        alert("Email đã được gửi thành công!");

                        document.getElementById('emailForm').style.display = 'none';//NoteTruc

                        document.getElementById('emailQuenMk').readOnly = true;
                        document.getElementById('btnGuiMail').hidden = true;
                    } else {
                        alert("Email không có trong hệ thống. Vui lòng thử lại!");
                    }
                },
                error: function () {
                    alert("Đã có lỗi xảy ra khi gửi yêu cầu.");
                }
            });
        });

        $("#btnXacNhan").on("click", function () {
            var MaXacNhanInput = $("#confirmationCode").val();

            console.log("MaXacNhanInput:", MaXacNhanInput);
            console.log("confirmationCode:", confirmationCode);

            if (MaXacNhanInput === confirmationCode) {
                console.log('Đúng');

                document.getElementById('confirmationSection').style.display = 'none';//NoteTruc

                document.getElementById('confirmationCode').readOnly = true;
                document.getElementById('btnXacNhan').hidden = true;
                $('#PasswordSection').show();
            } else {
                console.log('Sai');
                alert("Mã xác nhận sai. Vui lòng thử lại!");
            }
        });
        $("#btn_LuuMatKhau").on("click", function () {
            var email = $("#emailQuenMk").val();
            var password = $("#passwordMoi").val();
            var confirmPassword = $("#confirmPasswordMoi").val();
            if (password.trim() == "") {
                alert("Vui lòng nhập mật khẩu");
            }
            else if (password === confirmPassword) {
                sendNewPassword(email, password);
            }

            else {
                alert("Mật khẩu mới không khớp. Vui lòng nhập lại!");
            }
        });

        function sendNewPassword(email, password) {
            $.ajax({
                type: "POST",
                url: "/Login/QuenMatKhau",
                data: { Email: email, NewPassword: password },
                success: function (response) {

                    alert("Mật khẩu đã được cập nhật thành công!");
                    document.getElementById('PasswordSection').style.display = 'none';
                    document.getElementById('ChangeSuccess').style.display = '';
                    //location.reload();//NoteTruc
                },
                error: function () {
                    alert("Đã có lỗi xảy ra khi gửi yêu cầu.");
                }
            });
        }
    });

</script>